# ESP8266_Clock

使用esp8266驱动TIM1628驱动6个数码管显示时间


- ds3231时间 	
- 光敏电阻自动配置亮度/手动设置亮度
- ~~水银开关自动配置数码管方向~~
- wifi连接失败20次后等待1分钟后重试
- SmartConfig配置wifi
- 每小时整点自动网络校时
- 日期时间交替显示
- 在线升级

## 电路图

见 [PCB_LED_6_ESP8266.pdf](https://github.com/a2633063/ESP8266_Clock/blob/master/PCB_LED_6_ESP8266.pdf)

## 通讯协议

wifi通信使用UDP通信协议,发送十六进制值

>  举例说明:
>  esp8266mac地址最后8位为0xe2
> 设置第2组闹钟为每周一与周六晚上20:00:
> 则app通过udp发送命令:`A5 5A 0A E2 03 02 01 21 14 00`
> ESP8266收到数据后会返回命令:`A5 5A 0A E2 03 02 01 21 14 00`



### APP发送给ESP8266

格式如下(每个为一个字节):

> A5 5A Length MAC CMD DATA1 DATA2 DATA3.... DATAn....

其中 `A5 5A`包头,表示数据开始

`Length`为数据总长度,包含包头长度及MAC CMD DATA;1字节

`MAC`为ESP8266设备MAC地址最后8位,当为FF时,为所有接收到的设备; 1字节

`CMD`为命令含义,见下表;1字节

`DATA1-DATAn`为命令对应数据,可以为n个字节,n可以为0;(由于Length为8bit,所以DATA最长为255-5=250字节长度)



| CMD命令(十六进制) | DATA                                                         | 说明                                                         |
| :---------------: | :----------------------------------------------------------- | :----------------------------------------------------------- |
|        00         | 无                                                           | 回应设备MAC地址及IP地址                                      |
|        01         | DATA1:亮度                                                   | 设置亮度/自动亮度;<br />0-7:设置亮度,<br />8:自动亮度<br />FF:查询当前亮度 |
|        02         | DATA1:闹钟总开关                                             | 1:开<br />0:关<br />FF:查询                                  |
|        03         | DATA1:闹钟编号<br />DATA2:闹钟开关<br />DATA3:闹钟重复设置<br />  bitX: 每周X+1响( 7>=x>=1)<br />  bit7: 1:每天<br />  全部为0时为响一次<br />DATA4:闹钟时<br />DATA5:闹钟分 | 设置闹钟<br />无DATA时为查询所有闹钟设置<br />只有DATA1时为查询对应编号闹钟设置 |
|        04         | DATA1:0/1<br />                                              | 设置显示方向<br />0:正向<br />1:反向<br />其他:查询方向      |
|        FF         | DATA1-4:ip地址                                               | 在线更新,<br />bin文件路径为:<br />DATA1.DATA2.DATA3.DATA4/ESP/userX.4096.new.6.bin<br />(X为1或2,根据ESP8266当前FW user bin) |





### ESP8266发送给APP

格式与app发送给ESP8266相同,格式如下(每个为一个字节):

> A5 5A Length M4AC CMD DATA1 DATA2 DATA3.... DATAn....

其中 `A5 5A`包头,表示数据开始

`Length`为数据总长度,包含包头长度及MAC CMD DATA;1字节

`MAC`为ESP8266设备MAC地址最后8位,当为FF时,为所有接收到的设备; 1字节

`CMD`为命令含义,与app发送给ESP8266相同,见下表;1字节

`DATA1-DATAn`为命令对应数据,可以为n个字节,n可以为0;(由于Length为8bit,所以DATA最长为255-5=250字节长度)



| CMD命令(十六进制) | DATA                                                         | 说明                                                        |
| :---------------: | :----------------------------------------------------------- | :---------------------------------------------------------- |
|        00         | DATA1-DATA6:ESP8266MAC地址<br />DATA7-DATA10:ESP8266 IP地址  | 回应设备MAC地址及IP地址                                     |
|        01         | DATA1:亮度                                                   | 当前亮度/自动亮度;<br />0-7:设置亮度,<br />8:自动亮度<br /> |
|        02         | DATA1:闹钟总开关                                             | 1:开<br />0:关<br />FF:查询                                 |
|        03         | DATA1:闹钟编号<br />DATA2:闹钟开关<br />DATA3:闹钟重复设置<br />  bitX: 每周X+1响( 7>=x>=1)<br />  bit7: 1:每天<br />  全部为0时为响一次<br />DATA4:闹钟时<br />DATA5:闹钟分 | 查询闹钟                                                    |
|        04         | DATA1:显示方向                                               | 查询显示方向<br />0:正向<br />1:反向                        |



## 在线更新

更新FW后,支持在线更新FW版本

### 生成user bin文件

根据esp8266的在线ota说明,需要生成user bin,如果esp8266当前使用的是1,则生成的则为2.如果你不知道当前使用的哪个,建议两个都生成,并放在同一个目录下,让esp8266去自动选择.

在Makefile中,第24行`APP?=1`后面的1改为对应的1或2,保存后在build即可.得到bin文件:usr1.4096.new.6.bin或user2.4096.new.6.bin文件

### 架设服务器

esp8266需要去服务器上抓取bin文件,为了方便,这里直接自己来架设服务器,你需要启动IIS服务(不会请自行百度google),并新增一个端口为80的web服务,随意指向一个路径(如G:\WebShare),将这个服务的目录浏览功能打开.

最后在目录下建立文件夹ESP(如:G:\WebShare\ESP),将上面生成的bin文件放到这个目录下

```
G:\WebShare\ESP\usr1.4096.new.6.bin
G:\WebShare\ESP\usr2.4096.new.6.bin
```

最后,验证你的服务器正常(假设你的服务器ip为:192.168.1.100):

通过网页打开网站http://192.168.1.100/ESP/usr1.4096.new.6.bin 或http://192.168.1.100/ESP/usr2.4096.new.6.bin ,能够成功的下载bin文件即可. 注意:最好使用局域网内其他设备测试.

### 更新FW

至此准备已经全部完成,现在你可以通过UDP发送升级fw命令给ESP8266让它升级FW

假设你的服务器ip为192.168.1.100,你的esp8266已经连上你的局域网且MAC地址最后8位为E2,则升级命令为:

```
A5 5A 09  E2  FF  C0  A8 01 64
 包头 长度 MAC cmd 192 168 1 100
```

等待一会即可升级完成.注意:暂时在升级过程中无任何进度或其他提示.